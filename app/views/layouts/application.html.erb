<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Triangle Tots" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Triangle Tots">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>

    <script>
      // Location management functions
      const LocationManager = {
        STORAGE_KEY: 'triangleTots_homeLocation',

        // Check if location exists in localStorage
        hasLocation() {
          return localStorage.getItem(this.STORAGE_KEY) !== null;
        },

        // Get location from localStorage
        getLocation() {
          const data = localStorage.getItem(this.STORAGE_KEY);
          return data ? JSON.parse(data) : null;
        },

        // Save location to localStorage
        saveLocation(latitude, longitude) {
          const data = { latitude, longitude };
          localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data));
        },

        // Clear location from localStorage
        clearLocation() {
          localStorage.removeItem(this.STORAGE_KEY);
        },

        // Request geolocation from browser
        requestGeolocation() {
          if (!navigator.geolocation) {
            alert('Geolocation is not supported by your browser.');
            return;
          }

          navigator.geolocation.getCurrentPosition(
            (position) => {
              const { latitude, longitude } = position.coords;
              this.saveLocation(latitude, longitude);
              this.reloadWithLocation();
            },
            (error) => {
              let errorMsg = 'Unable to get your location. ';
              if (error.code === error.PERMISSION_DENIED) {
                errorMsg += 'Please enable location access in your browser settings and try again.';
              } else if (error.code === error.POSITION_UNAVAILABLE) {
                errorMsg += 'Location information is unavailable.';
              } else if (error.code === error.TIMEOUT) {
                errorMsg += 'The request to get your location timed out.';
              } else {
                errorMsg += 'An unknown error occurred.';
              }
              alert(errorMsg);
            },
            {
              enableHighAccuracy: false,
              timeout: 10000,
              maximumAge: 300000 // 5 minutes
            }
          );
        },

        // Reload page with location parameters
        reloadWithLocation() {
          const location = this.getLocation();
          if (location) {
            const url = new URL(window.location.href);
            url.searchParams.set('home_lat', location.latitude);
            url.searchParams.set('home_lng', location.longitude);
            window.location.href = url.toString();
          }
        },

        // Initialize on page load
        init() {
          // Check if location exists
          if (!this.hasLocation()) {
            // No location stored, automatically request it
            this.requestGeolocation();
          } else {
            // Location exists, add it to current URL if not already present
            const urlParams = new URLSearchParams(window.location.search);
            if (!urlParams.has('home_lat') || !urlParams.has('home_lng')) {
              this.reloadWithLocation();
            }
          }
        }
      };

      // Initialize when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => LocationManager.init());
      } else {
        LocationManager.init();
      }

      // Make LocationManager available globally for "Change Location" link
      window.LocationManager = LocationManager;
    </script>
  </head>

  <body class="min-h-screen" style="background-color: #FAF9F4;">
    <%= yield %>
  </body>
</html>
